<?php
/**
 * @file
 * This module handles the authentication of user when required by Ezproxy.
 *
 * When user are correctly authenticated the control are returned to Ezproxy
 * with construct of a Ticket-url.
 */

define('TING_EZPROXY_AUTHENTICATION_URL', 'ting_ezproxy_authentication');

/**
 * Implements hook_menu().
 */
function ting_ezproxy_menu() {
  $items = array();

  $items['admin/config/ting/ezproxy'] = array(
    'title' => 'EZproxy settings',
    'description' => 'Configure EZproxy authenticaton',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ting_ezproxy_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
    'file' => 'ting_ezproxy.admin.inc',
    'weight' => 10,
  );

  $items[TING_EZPROXY_AUTHENTICATION_URL] = array(
    'title' => 'Ezproxy authentication',
    'description' => 'EZProxy menu callback to handle authentication',
    'page callback' => 'ting_ezproxy_handler',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Menu callback that handles authentication of the current logged in users.
 */
function ting_ezproxy_handler() {
  global $user;

  // Get config values.
  $configuration = variable_get('ting_ezproxy', array());

  if (user_is_anonymous()) {
    // Get text and replace token.
    $text = strtr($configuration['text_anonymous'], array('@loginform' => drupal_get_form('user_login')));
  }
  else {
    // User is logged in.
    $status = ting_ezproxy_user_status($configuration['category'], $configuration['block']);

    if ($status) {
      // Get url from EZproxy
      // The content will be encoded in The EZproxy way eg. "ezp.2aH...s-" -
      // it's not a real url in this context.
      $url = $_GET['url'];

      // Make the EZproxy url with ticket using a non-critical id (uid).
      $url_redirect  = ting_ezproxy_generate_ticket($user->uid, $url);

      $waittime = intval($configuration['loggedin_time']);
      if ($waittime == 0) {
        drupal_goto($url_redirect);
      }
      else {
        // Get text and replace token with url.
        $text = strtr($configuration['text_loggedin'], array('@tokenurl' => $url_redirect));

        if ($waittime > 0) {

          drupal_add_html_head(array(
            '#tag' => 'meta',
            '#attributes' => array(
              'http-equiv' => 'refresh',
              'content' => $waittime . ';url=' . $url_redirect,
            ),
          ), 'exproxy');
        }
      }
    }
    elseif ($status === FALSE) {
      // Blocked or other error.
      $text = $configuration['text_error'];
    }
    else {
      // Wrong category.
      $text = $configuration['text_wrongcategory'];
    }
  }
  return '<div class="ting-ezproxy">' . $text . '</div>';
}

/**
 * Get the state of the user.
 *
 * @return mixed

 */

/**
 * Get the current logged in users stats.
 *
 * @param $category
 * @param $block
 *
 * @return bool|int
 *   1: user have the correct category
 *   0: user have a wrong category
 *   FALSE: some other error eg. blocked card, no connection to ding_provider,
 *          user is not alma_user
 *
 * @throws Exception
 */
function ting_ezproxy_user_status($category, $block) {
  global $user;

  // Try to get user credentials.
  try {
    $user_data = ding_user_get_creds($user);
  }
  catch (Exception $exception) {
    return FALSE;
  }

  // Default status to FALSE.
  $status = FALSE;

  // Check the user is in any categories.
  if (!empty($user_data['category'])) {
    // Have the user some blocks then vi return FALSE if this... ?
    if (isset($user_data['blocks']) && strlen($block)) {
      $block_list = explode(',', $block);
      $regexp = '/^(' . implode('|', preg_grep('/^\w+$/', $block_list)) . ')$/';
      foreach ($user_data['blocks'] as $ele) {
        if (!$ele['is_system'] && preg_match($regexp, $ele['code'])) {
          return FALSE;
        }
      }
    }

    // Make the regexp with allowed categories and check this.
    $catlist = explode(',', $category);
    $regexp = '/^(' . implode('|', preg_grep('/^\w+$/', $catlist)) . ')$/';

    $status = preg_match($regexp, $user_data['category']);
  }

  return $status;
}

/**
 * Generate an EZproxy ticket.
 *
 * @param $user
 * @param string $url
 *
 * @see http://www.oclc.org/support/documentation/ezproxy/usr/ticket/php.htm
 *
 * @return string
 */
function ting_ezproxy_generate_ticket($user, $url) {
  // Get config values.
  $configuration = variable_get('ting_ezproxy', array());

  $packet = '$u' . time();
  if (strcmp($configuration['citizen'], "") != 0) {
    $packet .= '$g' . $configuration['citizen'];
  }
  $packet .= '$e';
  $ez_proxy_ticket = urlencode(md5($configuration['secret'] . $user . $packet) . $packet);

  return $configuration['domain'] . "/login?user=" . urlencode($user) . "&ticket=" . $ez_proxy_ticket . "&qurl=" . urlencode($url);
}
